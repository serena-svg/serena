<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“Š Meta ç´ æåˆ†æç³»çµ± </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --fb: #1877F2; --winner: #2f855a; --risk: #d69e2e; --stop: #c53030; }
        body { font-family: "PingFang TC", sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-upload { background: var(--fb); color: white; padding: 12px 24px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; }
        .chart-box { height: 400px; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; margin-bottom: 30px; }
        th { background: #4a5568; color: white; padding: 12px; }
        td { padding: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .group-header { background: #edf2f7; font-weight: bold; color: #2d3748; text-align: left; padding: 12px 15px; border-left: 5px solid var(--fb); margin-top: 20px; }
        .badge { padding: 4px 10px; border-radius: 12px; color: white; font-weight: bold; font-size: 11px; }
        .bg-winner { background: var(--winner); } .bg-risk { background: var(--risk); } .bg-stop { background: var(--stop); }
    </style>
</head>
<body>
    <div class="card" style="text-align:center;">
        <h2>ğŸ“Š Meta ç´ æåˆ†æç³»çµ± (GitHub ç‰ˆ)</h2>
        <input type="file" id="csvFile" accept=".csv" style="display:none">
        <button class="btn-upload" onclick="document.getElementById('csvFile').click()">ğŸ“‚ ä¸Šå‚³ CSV å ±è¡¨</button>
    </div>
    <div id="results"></div>

    <script>
        document.getElementById('csvFile').addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = ev => analyze(ev.target.result);
            reader.readAsText(e.target.files[0]);
        });

        function analyze(csv) {
            const lines = csv.trim().split('\n');
            const h = lines[0].split(',');
            const findIdx = (ks) => h.findIndex(col => ks.some(k => col.includes(k)));
            
            const idx = {
                name: findIdx(["ç´ æ", "å»£å‘Šåç¨±"]),
                set: findIdx(["å—çœ¾", "å»£å‘Šçµ„åˆ"]),
                spend: findIdx(["èŠ±è²»"]), ctr: findIdx(["CTR"]), cpc: findIdx(["CPC"]), type: findIdx(["æˆæœé¡å‹"])
            };

            const data = lines.slice(1).map(l => {
                const c = l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
                if (c.length < 5) return null;

                let rawSet = c[idx.set]?.replace(/"/g,'') || "";
                let rawName = c[idx.name]?.replace(/"/g,'') || "";
                
                const isDate = (str) => /^\d{4}/.test(str);
                if (isDate(rawSet)) rawSet = c[idx.set + 1]?.replace(/"/g,'') || rawSet;
                if (isDate(rawName)) rawName = c[idx.name + 1]?.replace(/"/g,'') || rawName;

                const ctr = parseFloat(c[idx.ctr]) || 0;
                const cpc = parseFloat(c[idx.cpc]) || 0;

                return { 
                    set: rawSet, name: rawName, 
                    ctr: ctr.toFixed(1), cpc: cpc.toFixed(1), 
                    spend: parseFloat(c[idx.spend]) || 0, 
                    type: c[idx.type]?.replace(/"/g,'') || "å°æµæ•¸æ“š",
                    l: (ctr >= 4 && cpc <= 9) ? "ä¸»åŠ›ç´ æ" : (ctr >= 4 && cpc > 9) ? "å¯ç”¨ä½†è²´" : (ctr < 4 && cpc <= 9) ? "é¢¨éšªç´ æ" : "å•é¡Œç´ æ",
                    c: (ctr >= 4 && cpc <= 9) ? "bg-winner" : (ctr >= 4 && cpc > 9 || ctr < 4 && cpc <= 9) ? "bg-risk" : "bg-stop",
                    a: (ctr >= 4 && cpc <= 9) ? "æ”¾é‡æŠ•é" : (ctr >= 4 && cpc > 9) ? "å„ªåŒ–å—çœ¾" : (ctr < 4 && cpc <= 9) ? "å„ªåŒ–åœ–é¢" : "å»ºè­°åœæŠ•"
                };
            }).filter(d => d && d.spend > 0);

            render(data);
        }

        function render(data) {
            const out = document.getElementById('results'); out.innerHTML = "";
            const targets = [...new Set(data.map(i => i.type))];
            
            targets.forEach(t => {
                const groupByType = data.filter(i => i.type === t);
                const card = document.createElement('div'); card.className = 'card';
                const cid = `chart-${Math.random().toString(36).substr(2, 5)}`;
                
                const audienceGroups = {};
                groupByType.forEach(item => {
                    if (!audienceGroups[item.set]) audienceGroups[item.set] = [];
                    audienceGroups[item.set].push(item);
                });

                let tableHtml = "";
                Object.keys(audienceGroups).forEach(audience => {
                    tableHtml += `
                        <div class="group-header">ğŸ“ å—çœ¾åˆ†çµ„ï¼š${audience}</div>
                        <table>
                            <tr><th width="40%">ç´ æåç¨±</th><th width="15%">CTR</th><th width="15%">CPC</th><th width="15%">åˆ¤å®š</th><th width="15%">å°ç­–</th></tr>
                            ${audienceGroups[audience].map(i => `
                                <tr>
                                    <td style="font-weight:bold; text-align:left;">${i.name}</td>
                                    <td>${i.ctr}%</td><td>$${i.cpc}</td>
                                    <td><span class="badge ${i.c}">${i.l}</span></td>
                                    <td>${i.a}</td>
                                </tr>`).join('')}
                        </table>`;
                });

                card.innerHTML = `<h3>ğŸ¯ ç›®æ¨™é¡å‹ï¼š${t}</h3><div class="chart-box"><canvas id="${cid}"></canvas></div>${tableHtml}`;
                out.appendChild(card);
                
                new Chart(document.getElementById(cid), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'ç´ ææˆæ•ˆé›·é”',
                            data: groupByType.map(i => ({ x: parseFloat(i.cpc), y: parseFloat(i.ctr), info: `${i.set} | ${i.name}` })),
                            backgroundColor: groupByType.map(i => i.c==='bg-winner'?'#2f855a':(i.c==='bg-risk'?'#d69e2e':'#c53030')),
                            pointRadius: 10
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { tooltip: { callbacks: { label: ctx => `ã€${ctx.raw.info}ã€‘ CTR: ${ctx.parsed.y}%, CPC: $${ctx.parsed.x}` } } }
                    }
                });
            });
        }
    </script>
</body>
</html>
