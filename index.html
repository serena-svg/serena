<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Meta å°ˆæ¥­æ•¸æ“šå¤§è…¦ - ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --fb: #1877F2; --line: #06C755; --bg: #f8fafc; --winner: #2f855a; --risk: #d69e2e; --stop: #c53030; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 15px; }
        .card { background: white; padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .upload-zone { border: 2px dashed #cbd5e0; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; background: #fff; }
        .filter-bar { display: none; background: #edf2f7; padding: 15px; border-radius: 12px; margin-top: 20px; align-items: center; justify-content: center; gap: 10px; }
        .btn-fb { background: var(--fb); color: white; padding: 12px 24px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; }
        .btn-line { background: var(--line); color: white; padding: 8px 16px; border-radius: 8px; border: none; font-size: 13px; cursor: pointer; font-weight: bold; }
        .chart-box { height: 450px; margin: 25px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f1f5f9; padding: 12px; border: 1px solid #e2e8f0; }
        td { padding: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .badge { padding: 4px 10px; border-radius: 12px; color: white; font-weight: bold; font-size: 11px; }
        .bg-winner { background: var(--winner); } .bg-risk { background: var(--risk); } .bg-stop { background: var(--stop); }
        .advice { background: #f1f5f9; padding: 8px; border-radius: 8px; font-size: 11px; text-align: left; border-left: 4px solid var(--fb); margin-top: 5px; }
    </style>
</head>
<body>
    <div class="card" style="text-align:center;">
        <h2>ğŸ“Š å°ˆæ¥­æ•¸æ“šåˆ†æ (åè©èˆ‡é›·é”æ„Ÿæ‡‰ä¿®æ­£ç‰ˆ)</h2>
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
            <button class="btn-fb">ğŸ“‚ ä¸Šå‚³å»£å‘Š CSV</button>
            <input type="file" id="fileInput" accept=".csv" style="display:none">
        </div>
        <div class="filter-bar" id="filterBar">
            ğŸ—“ï¸ ç¯©é¸ï¼š<input type="date" id="sD"> è‡³ <input type="date" id="eD">
            <button class="btn-fb" style="padding: 6px 18px;" onclick="apply()">é‡æ–°æ•´ç†</button>
        </div>
    </div>
    <div id="results"></div>

    <script>
        let allData = [];
        document.getElementById('fileInput').addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = ev => { parse(ev.target.result); document.getElementById('filterBar').style.display='flex'; };
            reader.readAsText(e.target.files[0]);
        });

        function parse(csv) {
            const lines = csv.trim().split('\n');
            const h = lines[0].split(',');
            const find = ks => h.findIndex(col => ks.some(k => col.includes(k)));
            const idx = { name: 0, set: 1, spend: find(["èŠ±è²»"]), ctr: find(["CTR"]), cpc: find(["CPC"]), cpm: find(["CPM"]), type: find(["æˆæœé¡å‹"]), s: find(["é–‹å§‹"]), e: find(["çµæŸ"]) };
            
            allData = lines.slice(1).map(l => {
                const c = l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
                if (c.length < 5) return null;
                return {
                    name: c[0].replace(/"/g,''), // ç´ æ
                    set: c[1].replace(/"/g,''),  // å—çœ¾
                    spend: parseFloat(c[idx.spend])||0,
                    ctr: parseFloat(c[idx.ctr])||0,
                    cpc: parseFloat(c[idx.cpc])||0,
                    cpm: Math.round(parseFloat(c[idx.cpm])||0),
                    type: c[idx.resType]?.replace(/"/g,'') || "å°æµ",
                    s: c[idx.s]||"", e: c[idx.e]||""
                };
            }).filter(d => d && d.spend > 0);

            if(allData.length > 0) {
                document.getElementById('sD').value = allData[0].s;
                document.getElementById('eD').value = allData[0].e;
            }
            apply();
        }

        function apply() {
            const sd = document.getElementById('sD').value, ed = document.getElementById('eD').value;
            const groups = { "åå–®å»£å‘Š": [], "å°æµå»£å‘Š": [], "äº’å‹•å»£å‘Š": [] };
            
            allData.filter(d => d.s >= sd && d.e <= ed).forEach(d => {
                let target = d.type.includes("Lead") || d.type.includes("åå–®") ? "åå–®å»£å‘Š" : (d.type.includes("äº’å‹•") ? "äº’å‹•å»£å‘Š" : "å°æµå»£å‘Š");
                let item = {...d};
                // ä½¿ç”¨æ•™æåˆ¤æ–·æ¨™æº–
                if (d.ctr>=4 && d.cpc<=9) { item.l="ä¸»åŠ›ç´ æ"; item.c="bg-winner"; item.t="æ­£ç¢ºèªªæ³•ï¼šåœ–é¢å¸ç›ä¸”æˆæœ¬ä½ï¼Œå»ºè­°æ”¾é‡ä¸¦è¤‡è£½æˆåŠŸåœ–é¢é‚è¼¯ã€‚"; }
                else if (d.ctr<4 && d.cpc<=9) { item.l="é¢¨éšªç´ æ"; item.c="bg-risk"; item.t="æ­£ç¢ºèªªæ³•ï¼šCPCé›–ä½ä½†å¸ç›åŠ›ä¸è¶³ï¼Œå»ºè­°å„ªåŒ–æ–‡æ¡ˆä¸æ›åœ–ã€‚"; }
                else if (d.ctr>=4 && d.cpc>9) { item.l="å¯ç”¨ä½†è²´"; item.c="bg-risk"; item.t="æ­£ç¢ºèªªæ³•ï¼šåœ–é¢å¼·ä½†æˆæœ¬é«˜ï¼Œå»ºè­°ç¸®å°å—çœ¾ç²¾æº–åº¦ã€‚"; }
                else { item.l="å•é¡Œç´ æ"; item.c="bg-stop"; item.t="æ­£ç¢ºèªªæ³•ï¼šæˆæ•ˆèˆ‡æˆæœ¬çš†ä¸ä½³ï¼Œå»ºè­°ç«‹å³åœæŠ•ç¯€çœé ç®—ã€‚"; }
                groups[target].push(item);
            });
            render(groups);
        }

        function copy(target, items) {
            let msg = `ã€${target} æˆæ•ˆç°¡å ±ã€‘\næœŸé–“ï¼š${document.getElementById('sD').value} ~ ${document.getElementById('eD').value}\n`;
            items.slice(0, 3).forEach(i => {
                msg += `\nğŸ“å—çœ¾ï¼š${i.set}\nğŸ–¼ï¸ç´ æï¼š${i.name}\nğŸ“Šæ•¸æ“šï¼šCTR ${i.ctr.toFixed(1)}% / CPC $${i.cpc.toFixed(1)}\nğŸ§ å»ºè­°ï¼š${i.t}\n`;
            });
            navigator.clipboard.writeText(msg);
            alert("âœ… LINE å°ˆæ¥­å ±å‘Šæ–‡å­—å·²è¤‡è£½ï¼");
        }

        function render(groups) {
            const container = document.getElementById('results');
            container.innerHTML = "";
            Object.keys(groups).forEach(target => {
                const items = groups[target]; if (items.length === 0) return;
                const card = document.createElement('div'); card.className = 'card';
                const chartId = `chart-${target}`;
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>ğŸ¯ ç›®æ¨™ï¼š${target}</h3>
                        <button class="btn-line" onclick='copy("${target}", ${JSON.stringify(items)})'>ğŸ“‹ è¤‡è£½ LINE å ±å‘Šæ–‡å­—</button>
                    </div>
                    <div class="chart-box"><canvas id="${chartId}"></canvas></div>
                    <table>
                        <tr><th width="20%">å—çœ¾ (çµ„åˆ)</th><th width="30%">ç´ æ (åç¨±)</th><th>CTR</th><th>CPC</th><th>åˆ¤æ–·çµè«–</th></tr>
                        ${items.map(i => `<tr><td>${i.set}</td><td style="text-align:left; font-weight:bold;">${i.name}</td><td>${i.ctr.toFixed(1)}%</td><td>$${i.cpc.toFixed(1)}</td><td><span class="badge ${i.c}">${i.l}</span><div class="advice">${i.t}</div></td></tr>`).join('')}
                    </table>`;
                container.appendChild(card);
                
                new Chart(document.getElementById(chartId), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${target} åˆ†ä½ˆ`,
                            data: items.map(i => ({ x: i.cpc, y: i.ctr, info: `${i.set} | ${i.name}` })), // æ³¨å…¥å—çœ¾èˆ‡ç´ æè³‡è¨Š
                            backgroundColor: items.map(i => i.c==='bg-winner'?'#2f855a':(i.c==='bg-risk'?'#d69e2e':'#c53030')),
                            pointRadius: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(ctx) {
                                        return `å—çœ¾ç´ æï¼š${ctx.raw.info} (CTR: ${ctx.parsed.y}%, CPC: $${ctx.parsed.x})`;
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>