<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ˆæ¥­å»£å‘Šç´ æåˆ†æç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --fb: #1877F2; --winner: #2f855a; --risk: #d69e2e; --stop: #c53030; }
        body { font-family: "PingFang TC", sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-upload { background: var(--fb); color: white; padding: 12px 24px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; }
        .chart-container { height: 400px; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #4a5568; color: white; padding: 12px; }
        td { padding: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .badge { padding: 4px 10px; border-radius: 12px; color: white; font-weight: bold; font-size: 11px; }
        .bg-winner { background: var(--winner); } .bg-risk { background: var(--risk); } .bg-stop { background: var(--stop); }
    </style>
</head>
<body>
    <div class="card" style="text-align:center;">
        <h2>ğŸ“Š Meta ç´ æ & å—çœ¾åˆ¤æ–·å¤§è…¦ (GitHub ç‰ˆ)</h2>
        <input type="file" id="csvFile" accept=".csv" style="display:none">
        <button class="btn-upload" onclick="document.getElementById('csvFile').click()">ğŸ“‚ ä¸Šå‚³ CSV å ±è¡¨</button>
    </div>
    <div id="results"></div>

    <script>
        document.getElementById('csvFile').addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = ev => analyze(ev.target.result);
            reader.readAsText(e.target.files[0]);
        });

        function analyze(csv) {
            const lines = csv.trim().split('\n');
            const h = lines[0].split(',');
            
            // ä¿®æ­£ï¼šé¿é–‹æ—¥æœŸæ ¼å¼ï¼Œç²¾æº–æŠ“å–æ–‡å­—æ¬„ä½
            const findIdx = (ks) => h.findIndex(col => ks.some(k => col.includes(k)));
            const idx = {
                name: findIdx(["ç´ æ", "å»£å‘Šåç¨±"]),
                set: findIdx(["å—çœ¾", "å»£å‘Šçµ„åˆ"]),
                spend: findIdx(["èŠ±è²»"]), ctr: findIdx(["CTR"]), cpc: findIdx(["CPC"]), type: findIdx(["æˆæœé¡å‹"])
            };

            const data = lines.slice(1).map(l => {
                const c = l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
                if (c.length < 5) return null;
                const ctr = parseFloat(c[idx.ctr]) || 0;
                const cpc = parseFloat(c[idx.cpc]) || 0;
                let res = {
                    name: c[idx.name]?.replace(/"/g,'') || "æœªçŸ¥ç´ æ",
                    set: c[idx.set]?.replace(/"/g,'') || "æœªçŸ¥å—çœ¾",
                    ctr, cpc, spend: parseFloat(c[idx.spend]) || 0,
                    type: c[idx.type]?.replace(/"/g,'') || "å°æµå»£å‘Š"
                };

                // æ¯”ç…§å°æµç´ æå››è±¡é™åˆ¤æ–·æ¨™æº–
                if (ctr >= 4 && cpc <= 9) { res.l="ä¸»åŠ›ç´ æ"; res.c="bg-winner"; res.a="æ”¾é‡"; }
                else if (ctr >= 4 && cpc > 9) { res.l="å¸å¼•éŒ¯æ—ç¾¤"; res.c="bg-risk"; res.a="æ”¹æ–‡æ¡ˆæˆ–å—çœ¾"; }
                else if (ctr < 4 && cpc <= 9) { res.l="å°çœ¾ä½†ç²¾æº–"; res.c="bg-risk"; res.a="ä¿ç•™"; }
                else { res.l="å¯æ·˜æ±°"; res.c="bg-stop"; res.a="åœæŠ•"; }
                return res;
            }).filter(d => d && d.spend > 0);

            render(data);
        }

        function render(data) {
            const out = document.getElementById('results'); out.innerHTML = "";
            const targets = [...new Set(data.map(i => i.type))];
            
            targets.forEach(t => {
                const group = data.filter(i => i.type === t);
                const card = document.createElement('div'); card.className = 'card';
                const cid = `chart-${t.replace(/\s+/g, '')}`;
                card.innerHTML = `
                    <h3>ğŸ¯ ç›®æ¨™ï¼š${t}</h3>
                    <div class="chart-container"><canvas id="${cid}"></canvas></div>
                    <table>
                        <tr><th>å—çœ¾</th><th>ç´ æåç¨±</th><th>CTR</th><th>CPC</th><th>åˆ¤æ–·</th><th>å»ºè­°</th></tr>
                        ${group.map(i => `<tr><td>${i.set}</td><td style="font-weight:bold;">${i.name}</td><td>${i.ctr}%</td><td>$${i.cpc}</td><td><span class="badge ${i.c}">${i.l}</span></td><td>${i.a}</td></tr>`).join('')}
                    </table>`;
                out.appendChild(card);
                
                new Chart(document.getElementById(cid), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'ç´ ææˆæ•ˆé›·é”',
                            data: group.map(i => ({ x: i.cpc, y: i.ctr, info: `${i.set} | ${i.name}` })),
                            backgroundColor: group.map(i => i.c==='bg-winner'?'#2f855a':(i.c==='bg-risk'?'#d69e2e':'#c53030')),
                            pointRadius: 10
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: { label: ctx => `ã€${ctx.raw.info}ã€‘ CTR: ${ctx.parsed.y}%, CPC: $${ctx.parsed.x}` }
                            }
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>